<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>ArcGIS Developer Guide: Location Allocation</title>
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
      #infoPanel {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        padding: 15px;
        max-width: 300px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        font-family: "Avenir Next", "Helvetica Neue", Helvetica, Arial, sans-serif;
        font-size: 14px;
      }
      #infoPanel h3 {
        margin-top: 0;
        border-bottom: 1px solid #ccc;
        padding-bottom: 5px;
      }
      .facility-item {
        margin: 10px 0;
        padding: 5px;
        border-left: 3px solid #007ac2;
        padding-left: 8px;
      }
      .demand-item {
        margin: 5px 0;
        font-size: 12px;
        color: #555;
      }
    </style>

    <link rel="stylesheet" href="https://js.arcgis.com/4.34/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.34"></script>

    <script type="module">
      import { ARCGIS_API_KEY } from './config.js';

      const [
        esriConfig,
        Map,
        MapView,
        Graphic,
        GraphicsLayer,
        esriRequest,
        Polyline,
      ] = await $arcgis.import([
        "@arcgis/core/config.js",
        "@arcgis/core/Map.js",
        "@arcgis/core/views/MapView.js",
        "@arcgis/core/Graphic.js",
        "@arcgis/core/layers/GraphicsLayer.js",
        "@arcgis/core/request.js",
        "@arcgis/core/geometry/Polyline.js",
      ])

      esriConfig.apiKey = ARCGIS_API_KEY

      const url = "https://logistics.arcgis.com/arcgis/rest/services/World/LocationAllocation/GPServer/SolveLocationAllocation"

      // Facilities data
      const facilitiesData = [
        { name: "Existing Location", type: 1, coords: [-122.333906, 47.609152] },
        { name: "Candidate 1", type: 0, coords: [-122.333585, 47.604501] },
        { name: "Candidate 2", type: 0, coords: [-122.334550, 47.605557] },
        { name: "Candidate 3", type: 0, coords: [-122.337753, 47.609442] },
        { name: "Candidate 4", type: 0, coords: [-122.335319, 47.607317] }
      ]

      // Demand points data
      const demandPointsData = [
        { name: "Colman Building", weight: 1573, coords: [-122.335583, 47.603495] },
        { name: "Norton Parking Garage", weight: 1262, coords: [-122.33482, 47.603745] },
        { name: "DocuSign Tower", weight: 2385, coords: [-122.334151, 47.605060] },
        { name: "Fourth and Madison Building", weight: 1096, coords: [-122.333227, 47.605493] },
        { name: "Safeco Plaza", weight: 3618, coords: [-122.333899, 47.606190] },
        { name: "1201 Third Avenue", weight: 1782, coords: [-122.336163, 47.607204] },
        { name: "Puget Sound Plaza", weight: 2165, coords: [-122.335796, 47.608602] },
        { name: "Rainier Square", weight: 1316, coords: [-122.334881, 47.609021] },
        { name: "Century Square", weight: 1974, coords: [-122.337503, 47.610273] },
        { name: "Miken Building", weight: 3920, coords: [-122.336516, 47.609510] },
        { name: "Westlake Park", weight: 2467, coords: [-122.336353, 47.6110466] },
        { name: "U.S. Bank Centre", weight: 3997, coords: [-122.334571, 47.610492] },
        { name: "Westlake Center", weight: 2440, coords: [-122.337406, 47.611980] },
        { name: "Nordstrom Flagship Store", weight: 2438, coords: [-122.336295, 47.6123047] },
        { name: "Columbia Center", weight: 5400, coords: [-122.330746, 47.604502] },
        { name: "800 Fifth Avenue", weight: 3697, coords: [-122.330228, 47.605698] },
        { name: "Seattle Municipal Tower", weight: 2025, coords: [-122.329605, 47.605143] },
        { name: "Washington State Convention Center", weight: 1076, coords: [-122.331520, 47.611664] }
      ]

      const facilitiesLayer = new GraphicsLayer()
      const demandPointsLayer = new GraphicsLayer()
      const allocationLinesLayer = new GraphicsLayer()

      const map = new Map({
        basemap: "arcgis/streets",
        layers: [allocationLinesLayer, demandPointsLayer, facilitiesLayer],
      })

      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-122.333906, 47.607],
        zoom: 14,
        constraints: {
          snapToZoom: false,
        },
      })

      view.when(async () => {
        addFacilityGraphics()
        addDemandPointGraphics()
        solveLocationAllocation()
      })

      function addFacilityGraphics() {
        facilitiesData.forEach((facility) => {
          const graphic = new Graphic({
            geometry: {
              type: "point",
              longitude: facility.coords[0],
              latitude: facility.coords[1],
            },
            attributes: {
              Name: facility.name,
              FacilityType: facility.type
            },
            symbol: {
              type: "simple-marker",
              color: facility.type === 1 ? [0, 122, 194] : [200, 200, 200],
              size: facility.type === 1 ? 12 : 10,
              outline: {
                color: [255, 255, 255],
                width: 2
              }
            }
          })
          facilitiesLayer.add(graphic)
        })
      }

      function addDemandPointGraphics() {
        demandPointsData.forEach((demand) => {
          const graphic = new Graphic({
            geometry: {
              type: "point",
              longitude: demand.coords[0],
              latitude: demand.coords[1],
            },
            attributes: {
              Name: demand.name,
              Weight: demand.weight
            },
            symbol: {
              type: "simple-marker",
              color: [255, 100, 100],
              size: 6,
              outline: {
                color: [255, 255, 255],
                width: 1
              }
            }
          })
          demandPointsLayer.add(graphic)
        })
      }

      function solveLocationAllocation() {
        // Simple distance-based allocation algorithm
        // This is a simplified version for demonstration
        
        document.getElementById("infoPanel").innerHTML = 
          `<h3>Location Allocation</h3><p>Calculating optimal locations...</p>`
        
        // Calculate which candidates would serve the most demand
        const candidates = facilitiesData.filter(f => f.type === 0)
        const existing = facilitiesData.filter(f => f.type === 1)
        
        // Score each candidate based on total weighted demand within range
        const scores = candidates.map(candidate => {
          let totalWeight = 0
          demandPointsData.forEach(demand => {
            const dist = calculateDistance(candidate.coords, demand.coords)
            if (dist < 0.02) { // roughly 2km
              totalWeight += demand.weight
            }
          })
          return { ...candidate, score: totalWeight }
        })
        
        // Select top 2 candidates
        scores.sort((a, b) => b.score - a.score)
        const chosen = [...existing, scores[0], scores[1]]
        
        // Allocate each demand point to nearest chosen facility
        const allocations = []
        demandPointsData.forEach(demand => {
          let nearest = null
          let minDist = Infinity
          
          chosen.forEach(facility => {
            const dist = calculateDistance(facility.coords, demand.coords)
            if (dist < minDist) {
              minDist = dist
              nearest = facility
            }
          })
          
          if (nearest) {
            allocations.push({
              demandName: demand.name,
              demandWeight: demand.weight,
              facilityName: nearest.name,
              demandCoords: demand.coords,
              facilityCoords: nearest.coords
            })
          }
        })
        
        displayResults(chosen, allocations)
      }
      
      function calculateDistance(coord1, coord2) {
        const dx = coord1[0] - coord2[0]
        const dy = coord1[1] - coord2[1]
        return Math.sqrt(dx * dx + dy * dy)
      }

      function displayResults(chosenFacilities, allocations) {
        // Clear previous allocation lines
        allocationLinesLayer.removeAll()

        // Update facility graphics based on results
        facilitiesLayer.removeAll()
        
        chosenFacilities.forEach((facility) => {
          const isChosen = true
          
          const graphic = new Graphic({
            geometry: {
              type: "point",
              longitude: facility.coords[0],
              latitude: facility.coords[1],
            },
            attributes: {
              Name: facility.name,
              FacilityType: facility.type
            },
            symbol: {
              type: "simple-marker",
              color: [0, 255, 0],
              size: 14,
              outline: {
                color: [255, 255, 255],
                width: 2
              }
            }
          })
          facilitiesLayer.add(graphic)
        })
        
        // Show facilities that weren't chosen as gray
        facilitiesData.forEach((facility) => {
          if (!chosenFacilities.find(f => f.name === facility.name)) {
            const graphic = new Graphic({
              geometry: {
                type: "point",
                longitude: facility.coords[0],
                latitude: facility.coords[1],
              },
              attributes: {
                Name: facility.name,
                FacilityType: facility.type
              },
              symbol: {
                type: "simple-marker",
                color: [200, 200, 200],
                size: 10,
                outline: {
                  color: [255, 255, 255],
                  width: 2
                }
              }
            })
            facilitiesLayer.add(graphic)
          }
        })

        // Show allocation lines
        allocations.forEach((allocation) => {
          const graphic = new Graphic({
            geometry: {
              type: "polyline",
              paths: [[
                allocation.demandCoords,
                allocation.facilityCoords
              ]]
            },
            symbol: {
              type: "simple-line",
              color: [50, 150, 255, 0.3],
              width: 1
            },
            attributes: allocation
          })
          allocationLinesLayer.add(graphic)
        })

        // Calculate summary stats
        const facilityStats = {}
        allocations.forEach(alloc => {
          if (!facilityStats[alloc.facilityName]) {
            facilityStats[alloc.facilityName] = { count: 0, weight: 0 }
          }
          facilityStats[alloc.facilityName].count++
          facilityStats[alloc.facilityName].weight += alloc.demandWeight
        })

        updateInfoPanel(chosenFacilities, facilityStats, allocations.length)
      }

      function updateInfoPanel(chosenFacilities, facilityStats, totalAllocations) {
        const panel = document.getElementById("infoPanel")
        
        let html = "<h3>Location Allocation Results</h3>"
        html += "<p style='font-size: 12px; color: #666;'>Simplified distance-based allocation</p>"
        
        html += "<div style='margin-bottom: 15px;'>"
        html += "<strong>Chosen Facilities:</strong>"
        chosenFacilities.forEach(facility => {
          const stats = facilityStats[facility.name] || { count: 0, weight: 0 }
          html += `<div class="facility-item">`
          html += `<strong>${facility.name}</strong><br>`
          html += `Demand Count: ${stats.count}<br>`
          html += `Demand Weight: ${Math.round(stats.weight).toLocaleString()}`
          html += `</div>`
        })
        html += "</div>"

        html += "<div>"
        html += "<strong>Total Allocations:</strong> " + totalAllocations + " connections"
        html += "</div>"

        panel.innerHTML = html
      }
    </script>
  </head>
  <body>
    <div id="viewDiv"></div>
    <div id="infoPanel">
      <h3>Location Allocation</h3>
      <p>Loading analysis...</p>
    </div>
  </body>
</html>
